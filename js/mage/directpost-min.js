var directPost=Class.create();directPost.prototype={initialize:function(b,f,a,d,c,e){this.iframeId=f;this.controller=a;this.orderSaveUrl=d;this.nativeAction=e;this.cgiUrl=c;this.code=b;this.inputs=["cc_type","cc_number","expiration","expiration_yr","cc_cid"];this.headers=[];this.isValid=true;this.paymentRequestSent=false;this.isResponse=false;this.orderIncrementId=false;this.successUrl=false;this.hasError=false;this.tmpForm=false;this.onSaveOnepageOrderSuccess=this.saveOnepageOrderSuccess.bindAsEventListener(this);this.onLoadIframe=this.loadIframe.bindAsEventListener(this);this.onLoadOrderIframe=this.loadOrderIframe.bindAsEventListener(this);this.onSubmitAdminOrder=this.submitAdminOrder.bindAsEventListener(this);this.preparePayment()},validate:function(){this.isValid=true;this.inputs.each(function(a){if($(this.code+"_"+a)){if(!Validation.validate($(this.code+"_"+a))){this.isValid=false}}},this);return this.isValid},changeInputOptions:function(b,a){this.inputs.each(function(c){if($(this.code+"_"+c)){$(this.code+"_"+c).writeAttribute(b,a)}},this)},preparePayment:function(){this.changeInputOptions("autocomplete","off");if($(this.iframeId)){switch(this.controller){case"onepage":this.headers=$$("#"+checkout.accordion.container.readAttribute("id")+" .section");var b=$("review-buttons-container").down("button");b.writeAttribute("onclick","");b.stopObserving("click");b.observe("click",function(){if($(this.iframeId)){if(this.validate()){this.saveOnepageOrder()}}else{review.save()}}.bind(this));break;case"sales_order_create":case"sales_order_edit":var c=document.getElementsByClassName("scalable save");for(var a=0;a<c.length;a++){c[a].writeAttribute("onclick","");c[a].observe("click",this.onSubmitAdminOrder)}$("order-"+this.iframeId).observe("load",this.onLoadOrderIframe);break}$(this.iframeId).observe("load",this.onLoadIframe)}},loadIframe:function(){if(this.paymentRequestSent){switch(this.controller){case"onepage":this.paymentRequestSent=false;if(!this.hasError){this.returnQuote()}break;case"sales_order_edit":case"sales_order_create":if(!this.orderRequestSent){this.paymentRequestSent=false;if(!this.hasError){this.returnQuote()}else{this.changeInputOptions("disabled",false);toggleSelectsUnderBlock($("loading-mask"),true);$("loading-mask").hide();enableElements("save")}}break}if(this.tmpForm){document.body.removeChild(this.tmpForm)}}},loadOrderIframe:function(){if(this.orderRequestSent){$(this.iframeId).hide();var a=$("order-"+this.iframeId).contentWindow.document.body.innerHTML;this.saveAdminOrderSuccess(a);this.orderRequestSent=false}},showError:function(a){this.hasError=true;if(this.controller=="onepage"){$(this.iframeId).hide();this.resetLoadWaiting()}alert(a)},returnQuote:function(){var url=this.orderSaveUrl.replace("place","returnQuote");new Ajax.Request(url,{onSuccess:function(transport){try{response=eval("("+transport.responseText+")")}catch(e){response={}}if(response.error_message){alert(response.error_message)}$(this.iframeId).show();switch(this.controller){case"onepage":this.resetLoadWaiting();break;case"sales_order_edit":case"sales_order_create":this.changeInputOptions("disabled",false);toggleSelectsUnderBlock($("loading-mask"),true);$("loading-mask").hide();enableElements("save");break}}.bind(this)})},setLoadWaiting:function(){this.headers.each(function(a){a.removeClassName("allow")});checkout.setLoadWaiting("review")},resetLoadWaiting:function(){this.headers.each(function(a){a.addClassName("allow")});checkout.setLoadWaiting(false)},saveOnepageOrder:function(){this.hasError=false;this.setLoadWaiting();var a=Form.serialize(payment.form);if(review.agreementsForm){a+="&"+Form.serialize(review.agreementsForm)}a+="&controller="+this.controller;new Ajax.Request(this.orderSaveUrl,{method:"post",parameters:a,onComplete:this.onSaveOnepageOrderSuccess,onFailure:function(b){this.resetLoadWaiting();if(b.status==403){checkout.ajaxFailure()}}})},saveOnepageOrderSuccess:function(transport){if(transport.status==403){checkout.ajaxFailure()}try{response=eval("("+transport.responseText+")")}catch(e){response={}}if(response.success&&response.directpost){this.orderIncrementId=response.directpost.fields.x_invoice_num;var paymentData={};for(var key in response.directpost.fields){paymentData[key]=response.directpost.fields[key]}var preparedData=this.preparePaymentRequest(paymentData);this.sendPaymentRequest(preparedData)}else{var msg=response.error_messages;if(typeof(msg)=="object"){msg=msg.join("\n")}if(msg){alert(msg)}if(response.update_section){$("checkout-"+response.update_section.name+"-load").update(response.update_section.html);response.update_section.html.evalScripts()}if(response.goto_section){checkout.gotoSection(response.goto_section);checkout.reloadProgressBlock()}}},submitAdminOrder:function(){if(editForm.validate()){var a=$(editForm.formId).getInputs("radio","payment[method]").find(function(b){return b.checked});this.hasError=false;if(a.value==this.code){toggleSelectsUnderBlock($("loading-mask"),false);$("loading-mask").show();setLoaderPosition();this.changeInputOptions("disabled","disabled");this.paymentRequestSent=true;this.orderRequestSent=true;$(editForm.formId).writeAttribute("action",this.orderSaveUrl);$(editForm.formId).writeAttribute("target",$("order-"+this.iframeId).readAttribute("name"));$(editForm.formId).appendChild(this.createHiddenElement("controller",this.controller));disableElements("save");$(editForm.formId).submit()}else{$(editForm.formId).writeAttribute("action",this.nativeAction);$(editForm.formId).writeAttribute("target","_top");disableElements("save");$(editForm.formId).submit()}}},recollectQuote:function(){var c=["sidebar","items","shipping_method","billing_method","totals","giftmessage"];c=order.prepareArea(c);var a=order.loadBaseUrl+"block/"+c;var e=$("order-items_grid").select("input","select","textarea");var d={};for(var b=0;b<e.length;b++){if(!e[b].disabled&&(e[b].type!="checkbox"||e[b].checked)){d[e[b].name]=e[b].getValue()}}d.reset_shipping=true;d.update_items=true;if($("coupons:code")&&$F("coupons:code")){d["order[coupon][code]"]=$F("coupons:code")}d.json=true;new Ajax.Request(a,{parameters:d,loaderArea:"html-body",onSuccess:function(f){$(editForm.formId).submit()}.bind(this)})},saveAdminOrderSuccess:function(data){try{response=eval("("+data+")")}catch(e){response={}}if(response.directpost){this.orderIncrementId=response.directpost.fields.x_invoice_num;var paymentData={};for(var key in response.directpost.fields){paymentData[key]=response.directpost.fields[key]}var preparedData=this.preparePaymentRequest(paymentData);this.sendPaymentRequest(preparedData)}else{if(response.redirect){window.location=response.redirect}if(response.error_messages){var msg=response.error_messages;if(typeof(msg)=="object"){msg=msg.join("\n")}if(msg){alert(msg)}}}},preparePaymentRequest:function(b){if($(this.code+"_cc_cid")){b.x_card_code=$(this.code+"_cc_cid").value}var a=$(this.code+"_expiration_yr").value;if(a.length>2){a=a.substring(2)}var c=parseInt($(this.code+"_expiration").value,10);if(c<10){c="0"+c}b.x_exp_date=c+"/"+a;b.x_card_num=$(this.code+"_cc_number").value;return b},sendPaymentRequest:function(b){this.recreateIframe();this.tmpForm=document.createElement("form");this.tmpForm.style.display="none";this.tmpForm.enctype="application/x-www-form-urlencoded";this.tmpForm.method="POST";document.body.appendChild(this.tmpForm);this.tmpForm.action=this.cgiUrl;this.tmpForm.target=$(this.iframeId).readAttribute("name");this.tmpForm.setAttribute("target",$(this.iframeId).readAttribute("name"));for(var a in b){this.tmpForm.appendChild(this.createHiddenElement(a,b[a]))}this.paymentRequestSent=true;this.tmpForm.submit()},createHiddenElement:function(a,b){var c;if(isIE){c=document.createElement("input");c.setAttribute("type","hidden");c.setAttribute("name",a);c.setAttribute("value",b)}else{c=document.createElement("input");c.type="hidden";c.name=a;c.value=b}return c},recreateIframe:function(){if($(this.iframeId)){var b=$(this.iframeId).next();var d=$(this.iframeId).readAttribute("src");var a=$(this.iframeId).readAttribute("name");$(this.iframeId).stopObserving();$(this.iframeId).remove();var c='<iframe id="'+this.iframeId+'" allowtransparency="true" frameborder="0"  name="'+a+'" style="display:none;width:100%;background-color:transparent" src="'+d+'" />';Element.insert(b,{before:c});$(this.iframeId).observe("load",this.onLoadIframe)}}};